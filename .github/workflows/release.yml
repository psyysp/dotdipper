name: Release

on:
    push:
        tags:
            - "v*"

env:
    CARGO_TERM_COLOR: always

permissions:
    contents: write

jobs:
    build-macos:
        name: Build macOS (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact_name: dotdipper-x86_64-apple-darwin
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact_name: dotdipper-aarch64-apple-darwin

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo index
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/git
                  key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

            - name: Build release binary
              run: cargo build --release --target ${{ matrix.target }}

            - name: Create tarball
              run: |
                  mkdir -p release
                  cp target/${{ matrix.target }}/release/dotdipper release/
                  cd release
                  tar -czvf ../${{ matrix.artifact_name }}.tar.gz dotdipper
                  cd ..
                  shasum -a 256 ${{ matrix.artifact_name }}.tar.gz > ${{ matrix.artifact_name }}.tar.gz.sha256

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      ${{ matrix.artifact_name }}.tar.gz
                      ${{ matrix.artifact_name }}.tar.gz.sha256

    build-linux:
        name: Build Linux (${{ matrix.target }})
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      artifact_name: dotdipper-x86_64-unknown-linux-gnu
                    - target: aarch64-unknown-linux-gnu
                      artifact_name: dotdipper-aarch64-unknown-linux-gnu

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install cross-compilation tools
              if: matrix.target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Build release binary
              run: |
                  if [ "${{ matrix.target }}" = "aarch64-unknown-linux-gnu" ]; then
                    export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
                  fi
                  cargo build --release --target ${{ matrix.target }}

            - name: Create tarball
              run: |
                  mkdir -p release
                  cp target/${{ matrix.target }}/release/dotdipper release/
                  cd release
                  tar -czvf ../${{ matrix.artifact_name }}.tar.gz dotdipper
                  cd ..
                  sha256sum ${{ matrix.artifact_name }}.tar.gz > ${{ matrix.artifact_name }}.tar.gz.sha256

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: |
                      ${{ matrix.artifact_name }}.tar.gz
                      ${{ matrix.artifact_name }}.tar.gz.sha256

    create-release:
        name: Create GitHub Release
        needs: [build-macos, build-linux]
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release assets
              run: |
                  mkdir -p release-assets
                  find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release-assets/ \;
                  ls -la release-assets/

            - name: Generate release notes
              id: release_notes
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  cat << EOF > release_notes.md
                  ## Dotdipper $VERSION

                  ### Installation

                  #### macOS (Homebrew)
                  \`\`\`bash
                  brew tap psyysp/dotdipper
                  brew install dotdipper
                  \`\`\`

                  #### macOS (Manual)
                  \`\`\`bash
                  # Apple Silicon (M1/M2/M3)
                  curl -LO https://github.com/psyysp/dotdipper/releases/download/$VERSION/dotdipper-aarch64-apple-darwin.tar.gz
                  tar -xzf dotdipper-aarch64-apple-darwin.tar.gz
                  sudo mv dotdipper /usr/local/bin/

                  # Intel
                  curl -LO https://github.com/psyysp/dotdipper/releases/download/$VERSION/dotdipper-x86_64-apple-darwin.tar.gz
                  tar -xzf dotdipper-x86_64-apple-darwin.tar.gz
                  sudo mv dotdipper /usr/local/bin/
                  \`\`\`

                  #### Linux
                  \`\`\`bash
                  # x86_64
                  curl -LO https://github.com/psyysp/dotdipper/releases/download/$VERSION/dotdipper-x86_64-unknown-linux-gnu.tar.gz
                  tar -xzf dotdipper-x86_64-unknown-linux-gnu.tar.gz
                  sudo mv dotdipper /usr/local/bin/

                  # ARM64
                  curl -LO https://github.com/psyysp/dotdipper/releases/download/$VERSION/dotdipper-aarch64-unknown-linux-gnu.tar.gz
                  tar -xzf dotdipper-aarch64-unknown-linux-gnu.tar.gz
                  sudo mv dotdipper /usr/local/bin/
                  \`\`\`

                  ### Checksums
                  SHA256 checksums are provided for all binaries. Verify with:
                  \`\`\`bash
                  shasum -a 256 -c dotdipper-*.sha256
                  \`\`\`

                  ### What's Changed
                  See the [CHANGELOG](https://github.com/psyysp/dotdipper/blob/main/CHANGELOG.md) for details.
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: release_notes.md
                  files: release-assets/*
                  draft: false
                  prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    update-homebrew:
        name: Update Homebrew Formula
        needs: create-release
        runs-on: ubuntu-latest
        if: "!contains(github.ref, '-rc') && !contains(github.ref, '-beta') && !contains(github.ref, '-alpha')"

        steps:
            - name: Checkout tap repository
              uses: actions/checkout@v4
              with:
                  repository: psyysp/homebrew-dotdipper
                  token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
                  path: homebrew-tap

            - name: Download macOS artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Update formula
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}

                  # Get SHA256 checksums
                  SHA256_X86=$(cat artifacts/dotdipper-x86_64-apple-darwin/dotdipper-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
                  SHA256_ARM=$(cat artifacts/dotdipper-aarch64-apple-darwin/dotdipper-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')

                  # Update formula
                  cat > homebrew-tap/Formula/dotdipper.rb << EOF
                  class Dotdipper < Formula
                    desc "A safe, deterministic, and feature-rich dotfiles manager built in Rust"
                    homepage "https://github.com/psyysp/dotdipper"
                    version "$VERSION"
                    license "MIT"

                    on_macos do
                      if Hardware::CPU.arm?
                        url "https://github.com/psyysp/dotdipper/releases/download/v#{version}/dotdipper-aarch64-apple-darwin.tar.gz"
                        sha256 "$SHA256_ARM"
                      else
                        url "https://github.com/psyysp/dotdipper/releases/download/v#{version}/dotdipper-x86_64-apple-darwin.tar.gz"
                        sha256 "$SHA256_X86"
                      end
                    end

                    depends_on "age"

                    def install
                      bin.install "dotdipper"
                    end

                    test do
                      assert_match "dotdipper", shell_output("#{bin}/dotdipper --version")
                    end
                  end
                  EOF

            - name: Commit and push
              run: |
                  cd homebrew-tap
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add Formula/dotdipper.rb
                  git commit -m "Update dotdipper to ${GITHUB_REF#refs/tags/v}"
                  git push
